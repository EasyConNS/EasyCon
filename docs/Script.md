## ecp脚本格式说明

>基于伊机控v1脚本格式发展而来，目的是在尽量兼容旧语法的基础上补充完善。
>v1脚本使用正则匹配每行脚本的格式，对脚本上下文支持不足，也不利于后续扩展。
>设计脚本规范后实现词法分析、语法分析、AST生成


脚本按行分隔，每行作为完整的表达式，无特殊字符结尾，但特殊流程如if,for等需要多行关键字配合组成脚本块。

关键字识别时使用全大写，格式化时统一输出大写

## 程序语法

### 声明和赋值

#### 声明

常量

"_"开头的为常量，必须先定义再使用。例：_测试时间=100

普通变量

`$`或`$$`开头的为变量。例：$a=1, $$test=233 

搜图变量

`@`开头的为搜图变量，只能出现在赋值右侧(兼容)。例：$1=@闪光度(当前为搜图专属，返回对应搜图匹配度结果，不排除后期扩展)

#### 赋值

赋值左侧只能是常量、变量、数组索引中的一种

```
_常量1 = 1 + 1
$a *= 3
$$arr[_常量1] = 4
```

#### 数据类型

整数：

长度4字节，范围-2,147,483,648 到 2,147,483,647（具体实现可根据字面量大小自动缩减实际所用长度）

数组：

[整数(,整数)*]（不可变？）


字符串：

使用双引号`"`包含的任意字符。例："内容1"

例：
```
$a = 1
PRINT "产生了" & $a & "个对象。" # 使用&组合字符串和变量
result>产生了1个对象。
```

#### 算数表达式

+-*/\%^ 算数运算符

&|! >> << 位运算符

#### 比较表达式

`> >= < <= == !=`组合的表达式

#### 判断表达式

`and or not`组合的比较表达式，注意`not`是单目运算，只放在比较表达式前

#### 注释

目前只支持单行注释

`#`字符开始其后直到行尾全部为注释内容。例：$a=1 #定义变量a内容为1

#### 按键

- `A [50]`按下A键50ms，默认50ms(兼容)
- `A+L+R+DDOWN [100]`同时按下多个按键
- `HOME DOWN`(按住，需使用`HOME UP`松开)
- `<LS|RS> <RESET|UP|DOWNN|LEFT|RIGHT> [duringtime]`按照方向推左右摇杆,持续时间省略则保持，直到RESET
- `<LS|RS> <0-360>`按照角度推摇杆(兼容)

### 流程控制

#### 条件语句

语法
```
if 条件表达式
    代码块
#elif 条件表达式（可选）
    代码块
#else（可选）
    代码块
endif
```

这里的条件表达式可以是一个比较表达式或判断表达式

#### 循环语句

语法
```
for #无限循环，需使用break跳出
    代码块
next
```
```
for 数字 #变量/常量/数字，开始循环后改变变量值循环次数不变
    代码块
next
```
```
for 变量 = 起始数字 to 结束数字 [step 步长]
    代码块
next
```
```
    break <数字> #跳出循环，后接数字可指定跳出的层数（可选）
```
```
    continue #略过后续语句执行下一次循环
```

### 函数

定义语法
```
func 函数名(形参列表【可选】) #参数列表是用`,`分割的变量例：($a,$b,$c)
    代码块
#return 变量 #一个函数体中有且只能有一个return，且只能写在函数结尾（可选）
endfunc
```

调用语法
```
函数名(实参[,实参]*)
```

例：
```
func max($a,$b)
    $c= $a
    if $a <> $b
        $c= $b
    endif
return $c
endfunc

$result= max(1,2)
PRINT "最大值为" & $result
result>最大值为2
```

### 规范

#### 关键字

import/as
if/elif/else/endif
for/to/step/next/break/continue
func/return/endfunc
and/or/not
A、B、X、Y、L、R、ZL、ZR
MINUS(-)、PLUS(+)、LCLICK(按左摇杆)、RCLICK(按右摇杆)、HOME(返回主页/游戏)、CAPTURE(截屏)
DLEFT、DRIGHT、DUP、DDOWN(DPAD方向键)
UP,DOWN,RIGHT,LEFT(摇杆方向别名)
RESET(保留字)

#### 运算符

- 算数符号：+-*/(整除)%(取余数)\(舍入除)
- 位运算符号：&(与)|(或)^(异或)<</>>(左移右移)
- 单目运算符：~(取反)-(取负?)
- 赋值：=
- 比较：<、>、<=、>=、!=、==(双等比较)
- 特殊符号：()[]{},;:

#### 内置函数

等待：按照关键字处理，但实现上应使用库来实现，与虚拟机实现分离
```
WAIT(数字) #脚本延时毫秒数，可选，默认50
```

输出：#V1虚拟机兼容语法，无法使用通用语法解析，进行特殊处理

```
PRINT(输出内容) #使用&组合的字符串或表达式
ALERT(输出内容)
```

#### 库函数：#V1虚拟机遗留指令，后续更新计划由ffi实现类似功能

>rand、bool等

>考虑使用ffi扩充脚本函数库功能，如XoroshiroRNG算法等
